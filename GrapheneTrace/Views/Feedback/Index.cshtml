@model List<GrapheneTrace.Models.Feedback>

@{
    ViewData["Title"] = "My Feedback";
    var email = ViewBag.PatientEmail as string ?? "";
}

<h2 class="mb-3">My Feedback</h2>

<p class="text-muted">
    Logged in as <strong>@email</strong>
</p>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Leave New Feedback</h5>

        <!-- Explicit action so form always posts to /Feedback/Create -->
        <form action="@Url.Action("Create", "Feedback")" method="post">
            @Html.AntiForgeryToken()

            <div class="mb-3">
                <label class="form-label">Rating (optional, 1–5)</label>
                <input class="form-control"
                       name="rating"
                       type="number"
                       min="1"
                       max="5"
                       placeholder="e.g. 4" />
            </div>

            <div class="mb-3">
                <label class="form-label">Comment</label>
                <textarea class="form-control" name="comment" rows="3" required></textarea>
            </div>

            @* DataFileId is optional – keep hidden for now *@
            <input type="hidden" name="dataFileId" value="" />

            <button class="btn btn-primary">Submit Feedback</button>
        </form>
    </div>
</div>

<h3>Previous Feedback</h3>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">
        You have not submitted any feedback yet.
    </div>
}
else
{
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Rating</th>
                <th>Comment</th>
                <th>Clinician Reply</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in Model)
            {
                <tr>
                    <td>@f.CreatedAt.ToLocalTime().ToString("g")</td>

                    <td>@(f.Rating <= 0 ? "-" : f.Rating.ToString())</td>

                    <td>@f.Comment</td>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(f.ClinicianReply))
                        {
                            <div>@f.ClinicianReply</div>
                            <small class="text-muted">
                                Replied at @f.ClinicianReplyAt?.ToLocalTime().ToString("g")
                            </small>
                        }
                        else
                        {
                            <span class="text-muted">Awaiting clinician review</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
